<ng-container *ngIf="appointment$ | async as appointment; else loading">
  <div *ngIf="!showLoginAndMailForm; else loginAndMailFormTempl"
       class="wrapper">
    <ng-container *ngIf="!enrollmentGone; else emptyTmpl">
      <mat-card class="form float high">
        <mat-card-title class="headline" id="title">
          {{ isEdit ? 'Bearbeiten' : 'Anmelden' }}
        </mat-card-title>

        <mat-card-content>
          <form (ngSubmit)="parseDataFromEnrollmentForm()"
                [formGroup]="form_main"
                class="register-form">
            <div *ngIf="userIsLoggedIn && !this.isEdit"
                 [formGroup]="form_selfEnrollment"
                 class="additions tooltip-container">
              <mat-checkbox (change)="changeSelfEnrollment()"
                            formControlName="selfEnrollment"
                            id="selfEnrollment">
                Ich melde mich selber an
              </mat-checkbox>
              <!--suppress TypeScriptUnresolvedFunction -->
              <mat-icon #tooltip="matTooltip"
                        (click)="tooltip.toggle()"
                        class="tooltip"
                        matTooltip="{{'Diese Anmeldung wird mit deinem Account verbunden. ' +
                     'Somit kannst du von überall deine Anmeldung bearbeiten oder löschen.'}}">
                info
              </mat-icon>
            </div>

            <div>
              <mat-form-field class="name">
                <label for="name">
                  <input formControlName="name"
                         id="name"
                         placeholder="Name"
                         matInput
                         required>
                </label>
                <mat-error id="name-error">
                  {{ getNameErrorMessage() }}
                </mat-error>
              </mat-form-field>

              <div class="additions">
                <div *ngFor="let addition of getAdditionsControls(); let i = index;"
                     formArrayName="additions">
                  <mat-checkbox
                    [formControlName]="'' + i">
                    {{appointment.additions[i].name}}
                  </mat-checkbox>
                </div>
              </div>
            </div>

            <div [formGroup]="form_driverPassenger">
              <div *ngIf="appointment.driverAddition" class="driverAddition">
                <div>
                  <mat-checkbox
                    formControlName="driver">
                    Fahrer
                  </mat-checkbox>
                </div>

                <mat-form-field *ngIf="!getDriver().value; else driver">
                  <mat-label>Mich bitte mitnehmen</mat-label>
                  <mat-select formControlName="requirement" required>
                    <mat-option [value]="0"> ---</mat-option>
                    <mat-option [value]="1"> Nur Hin</mat-option>
                    <mat-option [value]="2"> Nur Zurück</mat-option>
                    <mat-option [value]="3"> Hin und Zurück</mat-option>
                  </mat-select>
                  <mat-error *ngIf="form_driverPassenger.get('requirement').invalid">
                    {{ getSelectErrorMessage() }}
                  </mat-error>
                </mat-form-field>

                <ng-template #driver>
                  <mat-form-field>
                    <mat-label>Ich fahre</mat-label>
                    <mat-select formControlName="service" required>
                      <mat-option [value]="1"> Nur Hin</mat-option>
                      <mat-option [value]="2"> Nur Zurück</mat-option>
                      <mat-option [value]="3"> Hin und Zurück</mat-option>
                    </mat-select>
                    <mat-error *ngIf="form_driverPassenger.get('service').invalid">
                      {{ getSelectErrorMessage() }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field class="seats">
                    <input formControlName="seats"
                           id="seats"
                           matInput
                           placeholder="FREIE Plätze"
                           required
                           type="number">
                    <mat-error *ngIf="form_driverPassenger.get('seats').invalid">
                      {{ getSeatsErrorMessage() }}
                    </mat-error>
                  </mat-form-field>
                </ng-template>
              </div>
            </div>

            <mat-form-field [formGroup]="form_main">
              <textarea cdkAutosizeMaxRows="5"
                        cdkAutosizeMinRows="1"
                        cdkTextareaAutosize
                        formControlName="comment"
                        id="comment"
                        matInput placeholder="Kommentar">
              </textarea>
            </mat-form-field>

            <div *ngIf="creatorError"
                 class="info">
              <mat-error id="creator-error">
                {{ getCreatorErrorMessage() }}
              </mat-error>
            </div>

            <div class="actions">
              <button [active]="sendingRequestEmit"
                      [innerValue]="isEdit ? 'Speichern' : 'Anmelden'"
                      [disabled]="creatorError"
                      appLoadingDisable
                      color="primary"
                      id="submit"
                      mat-raised-button>
                {{ isEdit ? 'Speichern' : 'Anmelden' }}
              </button>
              <button [queryParams]="{a: appointmentLink}"
                      [routerLink]="['/enroll']"
                      mat-raised-button
                      type="button">
                Zurück
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </ng-container>
  </div>
</ng-container>

<ng-template #emptyTmpl>
  <mat-card class="float error empty" id="enrollment-not-found">
    <img alt="error robot" src="/assets/img/404.svg">
    <span>Sorry, diese Anmeldung gibt es lieder nicht mehr.</span>
    <button [queryParams]="{a: appointmentLink}"
            [routerLink]="['/enroll']"
            mat-raised-button>
      Okay
    </button>
  </mat-card>
</ng-template>

<ng-template #loginAndMailFormTempl>
  <app-enrollment-login-mail
    (cancel)="mailFormCancel()"
    (done)="mailFormSubmit($event)">
  </app-enrollment-login-mail>
</ng-template>

<ng-template #loading>
  <app-loading *ngIf="!loaded && !showLoginAndMailForm"
               [@remove]>
  </app-loading>
  <app-fetch-appointment
    [done]="loaded && !showLoginAndMailForm">
  </app-fetch-appointment>
</ng-template>
