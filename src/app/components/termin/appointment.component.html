<ng-container *ngIf="appointment$ | async as appointment; else loadingTemplate">
  <app-appointment-data [appointment]="appointment"></app-appointment-data>

  <mat-card *ngIf="!authenticationService.userIsLoggedIn()"
            class="split slim">
    <span>Dir fehlen möglicherweise Berechtigungen für diesen Termin</span>

    <button [routerLink]="['/account/login']"
            [queryParams]="{returnUrl: router.routerState.snapshot.url}"
            color="primary" mat-raised-button>
      Login
    </button>
  </mat-card>

  <!--  <div *ngIf="userIsLoggedIn" id="telegramAuth">-->
  <!--    <script async src="https://telegram.org/js/telegram-widget.js?7"-->
  <!--            data-telegram-login="eca_cgh_bot"-->
  <!--            data-size="large"-->
  <!--            data-onauth="onTelegramAuth(user)"-->
  <!--            data-request-access="write"></script>-->
  <!--  </div>-->

  <mat-card *ngIf="!websocketSubscriptionEstablished && !hideWebsocketSubscriptionInformation" class="closable slim">
    <mat-icon (click)="hideWebsocketSubscriptionInformation = true" class="close">close</mat-icon>
    <ng-container *ngIf="websocketSubscriptionRetryCount < 5;">
       <span>
        Verbindung zum Server wird aufgebaut<br/>
        </span>
      <span class="decent">
        Versuch {{websocketSubscriptionRetryCount + 1}} von 5 ...
      </span>
    </ng-container>
    <ng-container *ngIf="websocketSubscriptionRetryCount === 5">
      <div class="split small">
        <span>Konnte keine Live-Verbindung aufbauen. Manuelles Neuladen notwendig!</span>
        <mat-icon (click)="retryWebsocketSubscription()">
          cached
        </mat-icon>
      </div>
    </ng-container>
  </mat-card>

  <mat-card *ngIf="updatingAppointmentInBackground" class="split slim">
    <span class="big">Termin wird aktualisiert ...</span>
    <mat-icon class="spinning reverse">cached</mat-icon>
  </mat-card>

  <mat-card *ngIf="hasAppointmentUpdate" class="split slim">
    <span class="big">Es sind neue Anmeldungen vorhanden.</span>
    <mat-icon (click)="manualReload()">cached</mat-icon>
  </mat-card>

  <mat-card *ngIf="!updateOnWsCallSettingDefined"
            class="closable">
    <mat-icon (click)="updateOnWsCallSettingDefined = true" class="close">close</mat-icon>
    <div class="split">
        <span class="big">
          Automatisch neuste Daten laden<br/>
          <app-auto-load-on-ws-call></app-auto-load-on-ws-call>
        </span>
      <mat-icon [routerLink]="['/settings']">open_in_new</mat-icon>
    </div>
  </mat-card>

  <ng-container *ngIf="enrollments$ | async as enrollments">
    <app-enrollment-list [appointment]="appointment"
                         [enrollments]="enrollments$ | async"
                         [isMain]="true"
                         #enrollments_actual
                         [subListTitle]="'Teilnehmer'"></app-enrollment-list>
    <app-enrollment-list *ngIf="limitReachedBeforeEnrollmentDeadline"
                         [appointment]="appointment"
                         [enrollments]="enrollmentsWaitingList$ | async"
                         [isMain]="false"
                         #enrollments_waiting
                         [subListTitle]="'Warteliste'"></app-enrollment-list>
    <app-enrollment-list [appointment]="appointment"
                         [enrollments]="enrollmentsLate$ | async"
                         [isMain]="false"
                         #enrollments_late
                         [subListTitle]="'Zu spät angemeldet'"></app-enrollment-list>
    <app-enrollment-list *ngIf="!limitReachedBeforeEnrollmentDeadline"
                         [appointment]="appointment"
                         [enrollments]="enrollmentsWaitingList$ | async"
                         [isMain]="false"
                         #enrollments_waiting
                         [subListTitle]="'Warteliste'"></app-enrollment-list>
  </ng-container>

  <div *ngIf="appointment.hidden"
       [routerLink]="['/support']"
       class="info spacing small link"
       fragment="anonymous">
    Warum sehe ich so wenig Anmeldungen?
  </div>

  <mat-card *ngIf="!hasEnrollments">
    <span>Es hat sich noch niemand angemeldet.</span>
  </mat-card>

  <div *ngIf="showEnrollmentHint"
       [queryParams]="{a: link}"
       [routerLink]="['/enroll/add']"
       class="custom-tooltip right bottom show">
    Jetzt anmelden
    <span class="close">
      <mat-icon (click)="closeEnrollmentHint()">close</mat-icon>
    </span>
  </div>

  <div [queryParams]="{a: link}"
       [routerLink]="['/enroll/add']"
       class="floating-button right hex-button">
    <div class="hex">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="hex">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <mat-icon>
      person_add
    </mat-icon>
  </div>

  <div *ngIf="appointment.driverAddition"
       [queryParams]="{a: link}"
       [routerLink]="['/appointment/driver']"
       class="floating-button left hex-button">
    <div class="hex">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="hex">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <mat-icon>
      directions_car
    </mat-icon>
  </div>
</ng-container>

<ng-template #loadingTemplate>
  <app-loading *ngIf="!loaded" [@remove]></app-loading>
  <app-fetch-appointment [done]="loaded"></app-fetch-appointment>
</ng-template>
